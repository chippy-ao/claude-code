---
description: 質問で要件を深掘りしてからプランニングする。曖昧な要件を明確化し、整理した内容をプランとして出力する。
argument-hint: "[相談内容（任意）]"
allowed-tools:
  - AskUserQuestion
  - Write
  - Read
  - Task
  - TodoWrite
  - WebSearch
  - WebFetch
  - Glob
  - Grep
---

# /plan-with-questions コマンド

ユーザーの曖昧な要件を質問によって明確化し、整理した内容をプランとして出力する。

## 実行フロー

### 1. 初期化フェーズ

引数が指定されている場合：
- その内容を相談内容として認識し、質問フェーズへ進む

引数が指定されていない場合：
- コマンドの役割を簡潔に説明する：
  「このコマンドは、相談内容について質問を通じて要件を明確化し、プランとして整理します。」
- AskUserQuestionツールで相談内容を質問する

### 2. 質問フェーズ（要件明確化）

以下の観点で3-5問程度の質問を設定し、AskUserQuestionツールを使って確認する：

**質問の観点**：
- **目的**: 何を達成したいのか？最終的なゴールは？
- **スコープ**: どこまでの範囲を対象とするか？制約や境界は？
- **技術選定**: 使用する技術やツールに制約はあるか？
- **優先順位**: 最も重要な要素は何か？トレードオフがある場合の判断基準は？
- **既存資産**: 参考にすべき既存コードやドキュメントはあるか？

**質問のルール**：
- 1回のAskUserQuestionで複数の質問をまとめて聞く（最大4問）
- ユーザーの回答に応じて、追加の質問が必要か判断する
- 曖昧な点がなくなるまで質問を繰り返す
- 「もう十分」「大丈夫」などの回答があれば次のフェーズへ進む

**情報収集が必要な場合**：
- 技術的な調査が必要ならWebSearchやWebFetchを使用
- プロジェクトの既存コードを確認する必要があればGlob/Grep/Readを使用

### 3. 合意確認フェーズ

質問で得た情報を整理し、以下の形式でユーザーに確認する：

```markdown
## 整理した要件

### 目的
[明確化された目的]

### スコープ
[対象範囲と制約]

### 技術方針
[技術選定や方針]

### 優先順位
[重要な要素とトレードオフ]

### 補足情報
[その他の重要な情報]
```

AskUserQuestionで「この整理内容で認識は合っていますか？」と確認する。
修正が必要な場合は、修正点を反映して再度確認する。

### 4. 出力形式選択フェーズ

合意が取れたら、AskUserQuestionで出力形式を選択してもらう。

**必ず以下の形式でAskUserQuestionを呼び出すこと**：
```json
{
  "questions": [{
    "question": "プランの出力形式を選んでください。",
    "header": "出力形式",
    "options": [
      {
        "label": "ファイル出力",
        "description": "tmp/{plan_name}.md にマークダウンファイルとして保存"
      },
      {
        "label": "Plan モードで実行",
        "description": "Claude Code の Plan エージェントを呼び出して実装計画を立てる"
      },
      {
        "label": "チャットで説明",
        "description": "このままチャットでプランを説明する（ファイル出力なし）"
      }
    ],
    "multiSelect": false
  }]
}
```

plan_name は整理した内容から適切な名前を自動生成する（例: `login-feature-plan`, `api-refactor-plan`）

### 5. プラン作成フェーズ

選択された形式に応じてプランを作成する：

**ファイル出力の場合**：
- Writeツールで `tmp/{plan_name}.md` にプランを出力
- プランの内容を簡潔に説明
- AskUserQuestionで最終承認を求める

**Plan モードで実行の場合**：
- Taskツールで Plan エージェント（subagent_type: "Plan"）を呼び出す
- 整理した要件をプロンプトとして渡す
- Plan エージェントの結果を確認し、必要に応じて調整

**チャットで説明の場合**：
- 整理した要件をもとに、実装プランをチャット上で詳細に説明
- ステップごとの作業内容、注意点、依存関係などを記載
- ファイル出力は行わない

### 6. 完了

- プランが承認されたら完了メッセージを出力
- 次のステップ（実装開始など）を提案する

## 注意事項

- 質問は具体的で、回答がなぜ重要かを説明する
- トレードオフ付きの選択肢を可能な限り提供する
- ユーザーが自信を持って選択できるよう影響を強調する
- 前提条件、推測、またはサイレントデフォルトを避ける
- 信頼度をパーセンテージで開示する（例: 「この方針でよいと思います（信頼度：85%）」）
