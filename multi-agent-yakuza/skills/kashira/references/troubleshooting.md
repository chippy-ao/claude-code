# トラブルシューティング

## よくある問題と対処法

### 補佐が応答しない

**症状**: Task() で補佐を起動したが、応答がない、または処理が停止している

**対処法**:
1. TaskOutput で補佐のタスク状態を確認
   ```python
   TaskOutput(task_id="hosa_task_id")
   ```
2. エラーが発生している場合は親父に報告し、再起動を検討
   ```
   「親父、補佐が応答しません。エラー内容: [詳細]。再起動してよろしいでしょうか？」
   ```
3. 承認後、TaskUpdate でタスクを failed に更新し、新しい Task で補佐を再起動

---

### タスクが複雑すぎる

**症状**: ユーザーからの命令が非常に大規模で、タスク分解が難しい

**対処法**:
1. AskUserQuestion で段階的実行を提案
   ```python
   AskUserQuestion(
       question="親父、このタスクは大規模なため、段階的に実行したほうが安全かと存じます。フェーズ1: [内容]、フェーズ2: [内容]で進めてよろしいでしょうか？",
       options=["段階的に実行", "一度に実行", "計画を先に確認"]
   )
   ```
2. 親父の回答に従って実行方針を決定

---

### 若いのの人数不足

**症状**: 並列実行したいタスクが6個以上ある（若いのは最大5人）

**対処法**:
1. AskUserQuestion で優先順位を確認
   ```python
   AskUserQuestion(
       question="親父、並列実行可能な若いのは5人までです。以下のタスクの優先順位を教えてください: [タスクリスト]",
       options=["優先度高いものから5個実行", "全て順次実行", "タスクを統合"]
   )
   ```
2. 親父の指示に従って実行計画を調整
3. 補佐に再計画を依頼

---

### エージェントからエラー応答

**症状**: 若いのや専門エージェントからエラーが返された

**対処法（自動リトライ可能な場合）**:
1. エラー内容を分析（ファイルパスミス、依存不足、構文エラーなど）
2. 補佐に再計画を依頼
   ```python
   Task(
       subagent_type="multi-agent-yakuza:hosa",
       description="エラー発生タスクの再計画",
       prompt="""
       以下のタスクでエラーが発生しました:
       【タスク】[内容]
       【エラー】[詳細]
       【原因分析】[推測]

       修正した実行計画を立案してください。
       """
   )
   ```
3. 再実行

**対処法（親父の判断が必要な場合）**:
1. 親父に報告
   ```
   親父、問題が発生しました。
   【問題】[エラー内容]
   【状況】完了: [タスク]、失敗: [タスク]
   【対処法の選択肢】
   1. [方法1]
   2. [方法2]
   ご指示をお願いいたします。
   ```
2. 親父の判断を待って対応

---

### 部分的成功（一部タスクだけ失敗）

**症状**: 5つのタスクのうち3つは成功、2つは失敗

**対処法**:
1. 成功したタスクを TaskUpdate で completed に更新
   ```python
   TaskUpdate(task_id="task1_id", status="completed")
   TaskUpdate(task_id="task2_id", status="completed")
   TaskUpdate(task_id="task3_id", status="completed")
   ```
2. 失敗したタスクを分析し、補佐に再計画を依頼
3. 失敗タスクのみを再実行
4. 親父に状況報告
   ```
   親父、部分的に完了しました。
   【完了】タスク1, 2, 3
   【失敗】タスク4, 5（原因: [詳細]）
   【対応】失敗分を再実行します。
   ```

---

### TaskUpdate ツールが使えない

**症状**: TaskUpdate を実行しようとするとエラーになる

**原因**: 若頭（Kashira）だけが TaskUpdate ツールを持ちます。補佐や若いのは持ちません。

**確認事項**:
- 自分が若頭スキルとして実行されているか？
- task_id が正しいか？（TaskList で確認）
- status の値が正しいか？（"in_progress", "completed", "failed" のいずれか）

---

### 専門エージェントが見つからない

**症状**: 補佐が「適切な専門エージェントが見つかりません」と報告

**対処法**:
1. 若いの（Wakashu）で対応可能か判断
2. 可能なら若いので実行
3. 不可能なら親父に報告し、代替案を提案
   ```
   親父、[タスク]に適した専門エージェントが見つかりませんでした。
   若いので対応するか、手動実行をお願いいたします。
   ```

---

## デバッグ手順

### 1. タスク状態の確認
```python
TaskList()  # 全タスクの状態を確認
```

### 2. 特定タスクの詳細確認
```python
TaskOutput(task_id="task_id")  # 特定タスクの出力を確認
```

### 3. エージェントの再起動
```python
# 失敗したタスクを failed に更新
TaskUpdate(task_id="failed_task_id", status="failed")

# 新しいタスクとして再実行
Task(subagent_type="...", description="...", prompt="...")
```

---

## 予防策

### 1. 指示の明確化
- 補佐への指示は具体的に（ファイルパス、期待される動作、制約条件）
- 曖昧な指示はエラーの原因になる

### 2. タスク分解の適切化
- 1タスクは小さく（1〜2ファイルの修正程度）
- 並列実行可能な単位に分割
- 依存関係を明確に

### 3. 進捗監視
- TaskOutput を定期的に実行（長時間かかるタスクの場合）
- エラーの早期発見

### 4. リトライ戦略
- 単純なエラーは自動リトライ
- 複雑な問題は親父に報告して判断を仰ぐ
