---
description: 質問で要件を深掘りしてからプランニングする。曖昧な要件を明確化し、整理した内容をプランとして出力する。
argument-hint: "[相談内容（任意）]"
allowed-tools:
  - AskUserQuestion
  - Write
  - Read
  - Task
  - TodoWrite
  - WebSearch
  - WebFetch
  - Glob
  - Grep
---

# /plan:digging コマンド

ユーザーの曖昧な要件を質問によって明確化し、整理した内容をプランとして出力する。

## 実行フロー

### 1. 初期化フェーズ

引数が指定されている場合：
- その内容を相談内容として認識し、質問フェーズへ進む

引数が指定されていない場合：
- コマンドの役割を簡潔に説明する：
  「このコマンドは、相談内容について質問を通じて要件を明確化し、プランとして整理します。」
- AskUserQuestionツールで相談内容を質問する

### 2. 質問フェーズ（要件明確化）

以下の観点で3-5問程度の質問を設定し、AskUserQuestionツールを使って確認する：

**質問の観点**：
- **目的**: 何を達成したいのか？最終的なゴールは？
- **スコープ**: どこまでの範囲を対象とするか？制約や境界は？
- **技術選定**: 使用する技術やツールに制約はあるか？
- **優先順位**: 最も重要な要素は何か？トレードオフがある場合の判断基準は？
- **既存資産**: 参考にすべき既存コードやドキュメントはあるか？

**質問のルール**：
- 1回のAskUserQuestionで複数の質問をまとめて聞く（最大4問）
- ユーザーの回答に応じて、追加の質問が必要か判断する
- 曖昧な点がなくなるまで質問を繰り返す
- 「もう十分」「大丈夫」などの回答があれば次のフェーズへ進む

**情報収集が必要な場合**：
- 技術的な調査が必要ならWebSearchやWebFetchを使用
- プロジェクトの既存コードを確認する必要があればGlob/Grep/Readを使用

### 3. 合意確認フェーズ

質問で得た情報を整理し、以下の形式でユーザーに確認する：

```markdown
## 整理した要件

### 目的
[明確化された目的]

### スコープ
[対象範囲と制約]

### 技術方針
[技術選定や方針]

### 優先順位
[重要な要素とトレードオフ]

### 補足情報
[その他の重要な情報]
```

AskUserQuestionで「この整理内容で認識は合っていますか？」と確認する。
修正が必要な場合は、修正点を反映して再度確認する。

### 4. 計画立案フェーズ（Plan エージェント）

合意が取れたら、**Plan エージェント**（`subagent_type: "Plan"`）を呼び出して実装計画を立案する。

```
Task ツール:
- subagent_type: "Plan"
- prompt: 整理した要件を渡し、実装計画の立案を依頼
```

Plan エージェントは以下を行う：
- コードベースの調査（Glob, Grep, Read）
- 実装手順の策定
- 変更対象ファイルの特定
- 注意点・リスクの洗い出し

**注意**: Plan エージェントはファイル保存を行わない。結果はテキストとして返却される。

### 5. 出力形式選択フェーズ

Plan エージェントの結果を受けて、AskUserQuestionで出力形式を選択してもらう。

**必ず以下の形式でAskUserQuestionを呼び出すこと**：
```json
{
  "questions": [{
    "question": "計画の出力形式を選んでください。",
    "header": "出力形式",
    "options": [
      {
        "label": "そのまま実装開始",
        "description": "Plan エージェントの計画に基づいて実装を開始する"
      },
      {
        "label": "ファイル保存",
        "description": "tmp/{plan_name}.md に計画をマークダウンファイルとして保存"
      },
      {
        "label": "チャットで説明",
        "description": "計画の説明のみで終了する（ファイル出力・実装なし）"
      }
    ],
    "multiSelect": false
  }]
}
```

plan_name は整理した内容から適切な名前を自動生成する（例: `login-feature-plan`, `api-refactor-plan`）

### 6. 出力フェーズ

選択された形式に応じて処理を行う：

**そのまま実装開始の場合**：
- Plan エージェントの計画に基づいて実装を開始する
- 必要に応じて進捗を報告しながら進める

**ファイル保存の場合**：
- Writeツールで `tmp/{plan_name}.md` に計画を出力
- 計画の内容を簡潔に説明
- 「後でこのファイルを参照して実装を依頼できます」と案内

**チャットで説明の場合**：
- Plan エージェントの計画をチャット上で詳細に説明
- ステップごとの作業内容、注意点、依存関係などを記載
- ファイル出力・実装は行わない

### 7. 完了

- 選択された処理が完了したら完了メッセージを出力
- 次のステップを提案する

## 注意事項

- 質問は具体的で、回答がなぜ重要かを説明する
- トレードオフ付きの選択肢を可能な限り提供する
- ユーザーが自信を持って選択できるよう影響を強調する
- 前提条件、推測、またはサイレントデフォルトを避ける
- 信頼度をパーセンテージで開示する（例: 「この方針でよいと思います（信頼度：85%）」）